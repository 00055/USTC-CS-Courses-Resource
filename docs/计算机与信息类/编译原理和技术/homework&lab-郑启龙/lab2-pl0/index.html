

<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    <link href="https://mbinary0.github.io/resource/github.markdown.css" rel="stylesheet">
  </head>
  <body>
     	<div><h2>
                <a href="../index.html">&nbsp;&nbsp;<i class="fa fa-level-up"></i>&nbsp;&nbsp;</a>:
                /<a href="../../../../index.html"><i class="fa fa-home"></i></a>/<a href="../../../index.html">计算机与信息类</a>/<a href="../../index.html">编译原理和技术</a>/<a href="../index.html">homework&lab-郑启龙</a>/<a href="index.html">lab2-pl0</a>
            </h2>
        </div>
        
        
        <h2>Directories</h2>
        <ul>
        <li><a href="declarationParser/index.html" ><i class="fa fa-folder"></i>&nbsp;declarationParser</a></li>
<li><a href="pl0_c/index.html" ><i class="fa fa-folder"></i>&nbsp;pl0_c</a></li>
<li><a href="实验二-第八组-设计与演示文档与源代码/index.html" ><i class="fa fa-folder"></i>&nbsp;实验二-第八组-设计与演示文档与源代码</a></li>
<li><a href="src/index.html" ><i class="fa fa-folder"></i>&nbsp;src</a></li>
<li><a href="test/index.html" ><i class="fa fa-folder"></i>&nbsp;test</a></li>
        </ul>

        <h2>Files</h2>
        <ul>
        <li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/parser.py" ><i class="fa fa-file-code-o"></i>&nbsp;parser.py---(29.84K)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/README.md" ><i class="fa fa-pencil-square-o"></i>&nbsp;README.md---(13.52K)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/实验二-第八组-设计与演示文档与源代码.zip" ><i class="fa fa-file-zip-o"></i>&nbsp;实验二-第八组-设计与演示文档与源代码.zip---(14.34M)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/token_scanner.py" ><i class="fa fa-file-code-o"></i>&nbsp;token_scanner.py---(2.80K)</a></li>
        </ul>

        <div style="text-decration:underline;display:inline">
        <a href="https://github.com/mbinary/USTC-CS-Courses-Resource.git" target="_blank" rel="external"><i class="fa fa-github"></i>&nbsp; Github</a>
        <a href="mailto:&#122;huheqin1@gmail?subject=反馈与建议" style="float:right" target="_blank" rel="external"><i class="fa fa-envelope"></i>&nbsp; Feedback</a>
        </div>

        <h1 style="color:red;text-align:center;" >Read Me</h1>

<h1 id="pl0-compiler">PL0-compiler</h1>
<blockquote>
<p>A compiler for c-like programming language <strong>based on</strong> PL0, which is a dynamic, strong typing language.</p>
</blockquote>
<p>See grammar <a href="#grammar">here</a>, <a href="https://en.wikipedia.org/wiki/PL/0">wikipedia-PL0</a>, and download <a href="src/编译原理和技术实践2017.pdf">this pdf(zh)</a> for more details.</p>
<h1 id="quickstart">QuickStart</h1>
<div class="codehilite"><pre><span></span>usage: parser.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-i<span class="o">]</span> <span class="o">[</span>-s<span class="o">]</span> <span class="o">[</span>-t<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-f FILE<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -i, --instruction     output instructions
  -s, --stack           output data stack when executing each instruction
  -t, --token           output tokens when parsing
  -v, --varible         output varibles <span class="k">for</span> every static environment
  -f FILE, --file FILE  compile and run codes. Without this arg, enter
                        interactive REPL
</pre></div>


<p>Run <code>python parse.py</code> and enter a REPL state, you can type and run sentences and expressions interactively</p>
<h1 id="examples">Examples</h1>
<p>Note that when in REPL, every sentence or expresion or block ends with '.'. But in program codes, only the whole program ends with a dot.</p>
<h2 id="interactive-expression">interactive-expression</h2>
<p>Therer are some expressions and sentence in file expr.txt, now test it.
<code>python parser.py -f test/expr.txt</code></p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="c1">// expression</span>
<span class="mi">2</span>     <span class="n">var</span> <span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="p">;.</span>

<span class="o">&gt;&gt;</span>  <span class="nl">c</span><span class="p">:</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="mf">1.</span>
<span class="o">&gt;&gt;</span> <span class="n">begin</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">!=</span><span class="mi">1</span> <span class="p">;</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">=</span><span class="mi">5</span> <span class="n">end</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">;</span> <span class="n">True</span><span class="p">;</span> <span class="n">True</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="k">for</span><span class="p">(;</span><span class="n">b</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="nl">b</span><span class="p">:</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span><span class="p">,</span><span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="p">.</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">14</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">60</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">58</span>
<span class="o">&gt;&gt;</span> <span class="n">begin</span> <span class="o">++</span><span class="mi">1</span><span class="o">--</span><span class="mi">1</span><span class="p">;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">%</span><span class="mi">2</span><span class="p">;</span> <span class="mi">2</span><span class="o">&amp;</span><span class="mi">1</span> <span class="n">end</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">;</span> <span class="mi">8</span><span class="p">;</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">&gt;&gt;</span>   <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="o">/%</span><span class="mf">2.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">;</span>
<span class="o">&gt;&gt;</span>    <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">2.</span>
<span class="n">line</span> <span class="mi">1</span><span class="o">:</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">.</span>
                <span class="o">^</span>
<span class="p">[</span><span class="n">Error</span><span class="p">]</span><span class="o">:</span> <span class="n">Expected</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="n">got</span> <span class="s">&quot;.&quot;</span>
<span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="o">!!</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mi">620448401733239439360000</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="k">if</span>   <span class="mi">0</span> <span class="n">then</span> <span class="mi">1</span>
<span class="mi">2</span>     <span class="n">elif</span> <span class="mi">1</span><span class="o">&gt;</span><span class="mi">2</span> <span class="n">then</span> <span class="mi">2</span>
<span class="mi">3</span>     <span class="n">elif</span> <span class="nb">false</span> <span class="n">then</span> <span class="mi">3</span>
<span class="mi">4</span>     <span class="k">else</span> <span class="mf">4.</span>

<span class="nl">result</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">;</span>
</pre></div>


<h2 id="fibonacci">fibonacci</h2>
<p>Run <code>python parser.py  -f test/fibonacci.txt</code></p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="n">func</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="mi">2</span>     <span class="n">begin</span>
<span class="mi">3</span>         <span class="k">if</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span> <span class="o">||</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span> <span class="n">then</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">4</span>         <span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="mi">5</span>     <span class="n">end</span> <span class="p">;</span>
<span class="mi">6</span>     <span class="n">var</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">7</span>     <span class="n">begin</span>
<span class="mi">8</span>         <span class="k">while</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">15</span> <span class="k">do</span>
<span class="mi">9</span>         <span class="n">begin</span>
<span class="mi">10</span>            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">fib</span><span class="p">[</span><span class="o">%</span><span class="n">d</span><span class="p">]</span><span class="o">=%</span><span class="n">d</span><span class="err">&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="mi">11</span>            <span class="nl">n</span> <span class="p">:</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">12</span>        <span class="n">end</span><span class="p">;</span>
<span class="mi">13</span>    <span class="n">end</span>
<span class="mi">14</span>    <span class="p">.</span>

<span class="n">fib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mi">8</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="mi">13</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="mi">21</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="mi">34</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="mi">55</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="mi">89</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="mi">144</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="mi">233</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="mi">377</span>
</pre></div>


<p>Try the following commands to explore more examples.</p>
<div class="codehilite"><pre><span></span>python parser.py -f test/factorial.txt
python parser.py -f test/closure.txt
python parser.py -f test/closure.txt -i
python parser.py -f test/closure.txt -t
python parser.py -f test/closure.txt -s
python parser.py -f test/closure.txt -istv
python parser.py  <span class="c1"># enter interactive repl</span>
</pre></div>


<h1 id="description">Description</h1>
<h2 id="ident-type">ident type</h2>
<ul>
<li>constant</li>
<li>varible</li>
<li>function</li>
</ul>
<h2 id="operator">operator</h2>
<h3 id="relation-opr">relation opr</h3>
<ul>
<li>\&lt;</li>
<li>></li>
<li>\&lt;=</li>
<li>>=</li>
<li>= equal </li>
<li>!=</li>
<li>odd  </li>
</ul>
<h3 id="bit-opr">bit opr</h3>
<ul>
<li>\&amp; bitand</li>
<li>| bitor</li>
<li>\~ bitnot</li>
<li>\&lt;\&lt; left shift</li>
<li>>> right shift</li>
</ul>
<h3 id="arithmetic-opr">arithmetic opr</h3>
<ul>
<li>+  add/plus</li>
<li>-  sub/minus</li>
<li>*  multiply</li>
<li>\/  divide</li>
<li>\/\% integer div</li>
<li>%  mod</li>
<li>\^  power</li>
<li>!  factorial</li>
</ul>
<h3 id="conditon-opr">conditon opr</h3>
<ul>
<li>?:  eg   a>b ? c:d</li>
</ul>
<h2 id="control-structure">control structure</h2>
<ul>
<li>if elif else</li>
<li>for</li>
<li>while</li>
<li>break</li>
<li>continue</li>
<li>return</li>
</ul>
<h2 id="builtin-function">builtin function</h2>
<ul>
<li>print(formatStr,arg1,...)</li>
<li>random(), random(n)</li>
</ul>
<h1 id="grammar">Grammar</h1>
<div class="codehilite"><pre><span></span><span class="n">program</span> <span class="k">=</span>  <span class="n">body</span> <span class="s">&quot;.&quot;</span>
<span class="n">body</span> <span class="k">=</span> <span class="o">{</span><span class="n">varDeclaration</span> <span class="s">&quot;;&quot;</span> <span class="o">|</span>  <span class="n">constDeclaration</span> <span class="s">&quot;;&quot;</span> <span class="o">|</span>  <span class="s">&quot;func&quot;</span> <span class="n">ident</span> <span class="s">&quot;(&quot;</span> <span class="n">arg_list</span>  <span class="s">&quot;)&quot;</span> <span class="n">body</span> <span class="s">&quot;;&quot;</span><span class="o">}</span>  <span class="n">sentence</span>

<span class="n">varDeclaration</span> <span class="k">=</span> <span class="s">&quot;var&quot;</span>  <span class="n">varIdent</span> <span class="o">{</span> <span class="s">&quot;,&quot;</span> <span class="n">varIdent</span><span class="o">}</span>
<span class="n">varIdent</span>  <span class="k">=</span> <span class="n">ident</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">=</span><span class="err">&quot;</span> <span class="kt">number</span><span class="o">]</span> <span class="o">|</span> <span class="n">ident</span>  <span class="o">{</span> <span class="s">&quot;[&quot;</span> <span class="n">number</span> <span class="s">&quot;]&quot;</span> <span class="o">}</span> 
<span class="n">constDeclaration</span> <span class="k">=</span> <span class="s">&quot;const&quot;</span> <span class="n">ident</span> <span class="s">&quot;=&quot;</span> <span class="n">number</span> <span class="o">{</span><span class="s">&quot;,&quot;</span> <span class="n">ident</span> <span class="s">&quot;=&quot;</span> <span class="n">number</span><span class="o">}</span>

<span class="n">sentence</span> <span class="k">=</span> <span class="o">[</span> <span class="kt">ident</span> <span class="err">&quot;</span><span class="kt">:=</span><span class="err">&quot;</span> <span class="o">{</span> <span class="kt">ident</span> <span class="err">&quot;</span><span class="kt">:=</span><span class="err">&quot;</span> <span class="o">}</span> <span class="kt">sentenceValue</span> 
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">begin</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="o">{</span> <span class="err">&quot;;&quot;</span> <span class="kt">sentence</span><span class="o">}</span>  <span class="err">&quot;</span><span class="kt">end</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">if</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">then</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="o">{</span><span class="err">&quot;</span><span class="kt">elif</span><span class="err">&quot;</span> <span class="kt">sentence</span><span class="o">}</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">else</span><span class="err">&quot;</span> <span class="kt">sentence</span><span class="o">]</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">while</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">do</span><span class="err">&quot;</span> <span class="kt">sentence</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">do</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="err">&quot;</span><span class="kt">while</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> 
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">switch</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">{</span><span class="err">&quot;</span><span class="kt">case</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">{</span><span class="err">&quot;</span>,<span class="err">&quot;</span> <span class="kt">sentenceValue</span><span class="o">}</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="o">[</span><span class="kt">setenceValue</span><span class="o">]}</span>  <span class="o">(</span><span class="kt">*</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">default</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span><span class="o">]</span>   <span class="kt">to</span> <span class="kt">do</span> <span class="kt">*</span><span class="o">)</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">break</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">continue</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="o">[</span><span class="err">&quot;</span><span class="kt">return</span><span class="err">&quot;</span><span class="o">]</span> <span class="kt">sentenceValue</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">print</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="o">(</span><span class="err">&quot;</span> <span class="kt">str</span>,<span class="kt">real_arg_list</span> <span class="err">&quot;</span><span class="o">)</span><span class="err">&quot;</span> <span class="o">]</span>

<span class="n">sentenceValue</span> <span class="k">=</span>   <span class="n">condition</span>

<span class="n">arg_list</span> <span class="k">=</span>  <span class="n">ident</span> <span class="o">{</span> <span class="s">&quot;,&quot;</span> <span class="n">ident</span><span class="o">}</span>

<span class="n">real_arg_list</span> <span class="k">=</span> <span class="n">sentenceValue</span> <span class="o">{</span><span class="s">&quot;,&quot;</span> <span class="n">sentenceValue</span> <span class="o">}</span>


<span class="n">condition</span> <span class="k">=</span> <span class="n">condition_or</span> <span class="o">[</span> <span class="err">&quot;</span><span class="kt">?</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">]</span>
<span class="n">condition_or</span>  <span class="k">=</span> <span class="n">condition_and</span> <span class="o">{</span> <span class="s">&quot;||&quot;</span> <span class="n">condition_or</span> <span class="o">}</span>
<span class="n">condition_and</span> <span class="k">=</span> <span class="n">condition_not</span> <span class="o">{</span> <span class="n">condition_not</span> <span class="s">&quot;&amp;&amp;&quot;</span> <span class="n">condition_and</span><span class="o">}</span>
<span class="n">condition_not</span> <span class="k">=</span> <span class="o">{</span><span class="s">&quot;!&quot;</span><span class="o">}</span> <span class="n">condition_unit</span>
<span class="n">condiiton_unit</span> <span class="k">=</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">odd</span><span class="err">&quot;</span><span class="o">]</span> <span class="n">expression</span>
                        <span class="o">|</span> <span class="n">expression</span> <span class="o">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&gt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&lt;=&quot;</span> <span class="o">|</span> <span class="s">&quot;&gt;=&quot;</span> <span class="o">|</span> <span class="s">&quot;=&quot;</span> <span class="o">|</span> <span class="s">&quot;!=&quot;</span><span class="o">)</span> <span class="n">expression</span>

<span class="n">expression</span> <span class="k">=</span>  <span class="n">level1</span> <span class="o">{</span> <span class="o">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="o">|</span> <span class="s">&quot;&gt;&gt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&amp;&quot;</span> <span class="o">|</span> <span class="s">&quot;|&quot;</span><span class="o">)</span> <span class="n">level1</span> <span class="o">}</span>
<span class="n">level1</span>  <span class="k">=</span> <span class="n">level2</span> <span class="o">{</span> <span class="o">(</span> <span class="s">&quot;+&quot;</span> <span class="o">|</span> <span class="s">&quot;-&quot;</span> <span class="o">)</span> <span class="n">level2</span> <span class="o">}</span>
<span class="n">level2</span> <span class="k">=</span> <span class="n">level3</span> <span class="o">{</span> <span class="s">&quot;*&quot;</span> <span class="o">|</span> <span class="s">&quot;/&quot;</span> <span class="o">|</span> <span class="s">&quot;/%&quot;</span> <span class="o">|</span> <span class="s">&quot;%&quot;</span> <span class="o">)</span> <span class="n">level3</span> <span class="o">}</span>
<span class="n">level3</span> <span class="k">=</span> <span class="n">level4</span> <span class="o">{</span><span class="s">&quot;^&quot;</span> <span class="n">level4</span><span class="o">}</span>
<span class="n">level4</span> <span class="k">=</span> <span class="n">item</span> <span class="o">{</span><span class="s">&quot;!&quot;</span><span class="o">}</span>          <span class="o">(*</span>  <span class="n">factorial</span> <span class="o">*)</span>
<span class="n">item</span> <span class="k">=</span>  <span class="n">number</span><span class="o">|</span><span class="s">&quot;true&quot;</span><span class="o">|</span><span class="s">&quot;false&quot;</span> <span class="o">|</span> <span class="n">ident</span> <span class="o">{</span> <span class="s">&quot;(&quot;</span> <span class="n">real_arg_list</span> <span class="s">&quot;)&quot;</span> <span class="o">}|</span> <span class="s">&quot;(&quot;</span> <span class="n">sentenceValue</span><span class="s">&quot; )&quot;</span> <span class="o">|</span> <span class="o">(</span><span class="s">&quot;+&quot;</span> <span class="o">|</span> <span class="s">&quot;-&quot;</span> <span class="o">|</span> <span class="s">&quot;~&quot;</span> <span class="o">)</span> <span class="n">item</span>
</pre></div>


<h2 id="syntax">syntax</h2>
<p>Writet down syntax, then convert left recursion to right recursion.
Namely we should change the following productions:
expr, level0, level, level3</p>
<p>We notice that</p>
<div class="codehilite"><pre><span></span><span class="n">A</span> <span class="o">-&gt;</span> <span class="nc">Aa</span><span class="o">|</span><span class="n">b</span>
</pre></div>


<p>equls to </p>
<div class="codehilite"><pre><span></span><span class="n">A</span> <span class="o">-&gt;</span> <span class="n">bR</span>
<span class="n">R</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="n">aR</span>
</pre></div>


<p>so here are the  right-recursion productions </p>
<div class="codehilite"><pre><span></span><span class="n">expr</span>   <span class="o">-&gt;</span> <span class="n">level1</span> <span class="n">interval1</span>
<span class="n">interval1</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">{&amp;|</span><span class="sc">&#39;|&#39;</span><span class="o">|&gt;&gt;|&lt;&lt;|}</span> <span class="n">interval1</span>

<span class="n">level1</span> <span class="o">-&gt;</span> <span class="n">level2</span> <span class="n">interval2</span>
<span class="n">interval2</span> <span class="o">-&gt;</span> <span class="n">nli</span> <span class="o">|</span> <span class="o">{+|-}</span> <span class="n">interval2</span>

<span class="n">level2</span> <span class="o">-&gt;</span> <span class="n">level3</span> <span class="n">interval3</span>
<span class="n">interval3</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">{*|/|//|%}</span> <span class="n">interval3</span>

<span class="n">level3</span> <span class="o">-&gt;</span> <span class="n">level4</span> <span class="o">|</span> <span class="n">level4</span> <span class="o">^</span> <span class="n">level3</span>

<span class="n">level4</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="n">interval4</span> 
<span class="n">interval4</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|!</span> <span class="n">interval4</span>

<span class="n">item</span>   <span class="o">-&gt;</span> <span class="nc">NUM</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="nc">PI</span><span class="o">|</span><span class="n">ln</span><span class="o">(</span><span class="n">expr</span><span class="o">)|(</span><span class="n">expr</span><span class="o">)|</span> <span class="o">+</span> <span class="n">item</span><span class="o">|</span> <span class="o">-</span> <span class="n">item</span><span class="o">|</span> <span class="o">~</span> <span class="n">item</span>
</pre></div>


<p>When implementing the parser, we can use a loop structure to implement the right recursion because it's tail-recursive.</p>
<p>For instance, we can simply find that the production for <code>level4</code> is </p>
<div class="codehilite"><pre><span></span><span class="n">level4</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="o">|</span> <span class="n">item</span> <span class="o">!</span> <span class="o">|</span> <span class="n">item</span><span class="o">!!</span> <span class="o">|</span><span class="n">item</span> <span class="o">!!!</span> <span class="o">|</span> <span class="o">...</span>
</pre></div>


<p>Though we can't write a production with infinite loops, we can write it in code like this: </p>
<div class="codehilite"><pre><span></span><span class="n">match_level4</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">lookAhead</span>  <span class="n">matches</span> <span class="n">item</span><span class="p">:</span>
        <span class="n">match</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>


<h1 id="instruction-generation">Instruction generation</h1>
<p>We designed several instructions that can be generated for the target machine. 
To simplify this problem, we will emulate this virtual machine and execute instructions in python.</p>
<h2 id="register">register</h2>
<p>This machine has three registers:
<em> <code>b</code> is the base register that contains the base pointer to locate a varible in the data stack
</em> <code>regs</code> are a series of registers. Currently the first one is used for returning value of latest function call, and the second one is used to store the <code>switch</code> value
* <code>pc</code> is the pc register that points to the instruction </p>
<h2 id="stack">stack</h2>
<p>There are two stack in this virtual machine. 
One contains the instructions, visited by register <code>pc</code>. It won't change when executing instructions, so we can assume it's readonly
The other is data stack. It dynamiclly changes when running the program.</p>
<p>For each level, the first is the base address of this level. The second place is the static chain to visit the upper level's varibles. The third place contains the return address of the upper level.
And the other places in one level contains local varibles and real time data for calculation.
<img alt="" src="src/data_stack.jpg" /></p>
<p>Each time we call a function, the level increases 1. Also, the level decreases 1 when we return from a function.</p>
<h2 id="instruction">instruction</h2>
<p>Every instruction consists of three parts. The first is the name of the instruction. Generally, the second is the level diifference of a identifier(if it has). And the third part is the address.</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">levelDiff</th>
<th align="center">address</th>
<th align="center">explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">INT</td>
<td align="center">0</td>
<td align="center">n</td>
<td align="center">allocate n space for one level</td>
</tr>
<tr>
<td align="center">INT</td>
<td align="center">1</td>
<td align="center">n</td>
<td align="center">rewind stk.top backward n steps</td>
</tr>
<tr>
<td align="center">INT</td>
<td align="center">2</td>
<td align="center">n</td>
<td align="center">print the top n elements of stack</td>
</tr>
<tr>
<td align="center">LIT</td>
<td align="center">-</td>
<td align="center">constant value</td>
<td align="center">push a constant value to the top of the data stack</td>
</tr>
<tr>
<td align="center">LOD</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">load a varible value to the top of the data stack. The var can be found use levelDiff and addr</td>
</tr>
<tr>
<td align="center">STO</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">store the stack top value to a varible, top decreases.</td>
</tr>
<tr>
<td align="center">CAL</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">call a function</td>
</tr>
<tr>
<td align="center">JMP</td>
<td align="center">-</td>
<td align="center">addr</td>
<td align="center">jmp to addr, namely set addr to pc</td>
</tr>
<tr>
<td align="center">JPC</td>
<td align="center">-</td>
<td align="center">addr</td>
<td align="center">pop stack, if the value is not True, jmp addr</td>
</tr>
<tr>
<td align="center">MOV</td>
<td align="center">n1</td>
<td align="center">n2</td>
<td align="center">stk[top-n2] = stk[top-n1]</td>
</tr>
<tr>
<td align="center">RET</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">return to the upper level, use current level's first three value to change pc, data stack, base register.</td>
</tr>
<tr>
<td align="center">POP</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">pop the data stack, store the value in <code>reg</code> register</td>
</tr>
<tr>
<td align="center">PUSH</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">push <code>reg</code> to stack top</td>
</tr>
<tr>
<td align="center">OPR</td>
<td align="center">-</td>
<td align="center">operator type</td>
<td align="center">variout operation on value</td>
</tr>
</tbody>
</table>
<h1 id="design">Design</h1>
<p>We can generate instruction when analysing grammar. 
Some keypoints is the control structures' instruction traslation.</p>
<h2 id="if-elif-else">if elif else</h2>
<p><img alt="" src="src/elseif_ins_stack.jpg" /></p>
<h2 id="whilebreak">while/break</h2>
<p><img alt="" src="src/while_ins_stack.jpg" />
<code>continue</code>, <code>for</code>  can be translated in the same way.</p>
<h2 id="switch">switch</h2>
<p>eg </p>
<div class="codehilite"><pre><span></span><span class="k">switch</span> <span class="n">n</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">1</span> <span class="n">or</span> <span class="mi">2</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">+</span><span class="mi">5</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;6&#39;</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">func_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>


<h2 id="function-arguments-pass">function arguments pass</h2>
<p>When analysing the function's defination, we can store the formal arguments as function's local varibles.
As soon as we call this function, we should calculate the real arguments in the level upper the function, and then pass value to the function's formal varibles one by one.</p>
<p>I use an instruction <code>MOV</code> to achive this goal. <code>MOV  addr1, addr2</code> will store value stk[top-n2] in stk[top-n1].
Let's have a look at how to call a function and pass args value.</p>
<p>Before we call a function, its real args will be calculated in the level upper this function. Note function level is n+1, and we call this function in level n.
In level n, we calculated function's args, all values are stored in the data stack of level n. Now call function and enter it. Data stack reaches level n+1 and grows three spaces for <code>DL</code>,<code>SL</code>,<code>RA</code>. The following space are for function's local varibles. So we can mov level n's real args value to these places according to function's argument num and varible num.</p>
<p>For example, function has n1 args, n2 local varibles(excluding args), then </p>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="o">.</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">mov</span> <span class="p">,</span> <span class="n">n2</span><span class="o">+</span><span class="n">n1</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">n2</span> <span class="o">+</span> <span class="n">i</span>
</pre></div>


<p>The moment we returned level n, we should rewind top for n1 spaces, <code>OPR,n1,'BACK'</code> can make it.</p>
<p><img alt="" src="src/argument_pass.jpg" /></p>
<h2 id="function-return">function return</h2>
<p>Also, mark function level as n+1, and outer(upper) is level n.
To implement <code>return</code> sentence, we just need to do two things:
<em> calculate <code>return</code> sentence value <strong>in level n+1</strong>
</em> pass this value to level n
It seems that it's hard to pass level n+1 's value to level n. Once we returned to level n, level n+1 's data in  data stack will be cleared.</p>
<p>I use a extra register <code>reg</code> to achive this. Before we return, 
<em> calculate return value
</em> <code>OPR ,0,'POP'</code>  will pop the value and store it in reg
<em> return level n
</em> <code>OPR,0,'PUSH'</code> will push reg value to stack top</p>
<p>Now the return value has be passed from level n+1 to level n
<img alt="" src="src/return_value.jpg" /></p>
<h2 id="instruction-backpatching">instruction backpatching</h2>
<p>Taking <code>while</code> block as an example, Note that we don't know the <code>JPC</code> instruction's target addr until we finish analysing the whole block.The Solution is that after we analyse while condition, we generate an instruction with no target address, just take a place. We note down this instruction's address. As soon as we finish analysing the whole  <code>while</code> block, the instruction pointer, namely <code>ip</code>, pointing to the target address of <code>JPC</code>. Then we backpatch the <code>JPC</code> instruction with the target address along to ip.</p>
<h2 id="symbol-table">symbol table</h2>
<p>When analysing and translating, we want to get the symbol which including level, address,(value for constant) according to its name. The following shows how to achive it elegantly</p>
<p>There are three types of symbols:
<em> constant
</em> varible
* function name
Every function has an environment that contains this level's symbols, and an outer environment(except main function). Every environment has the three symbols mentioned above.</p>
<p>Defaultly, we are in the main function in the beginning of this program.</p>
<p>In an enviroment, when we meet a symbol, we should seek it in current environment. If not found, go for the outer environment recursively until we found it.</p>
<p>It gurantees that every environment has no same names for different symbols but may have same names in different environment.</p>
<p>So there won't be conflits when different functions have same local varibles or arguments.</p>
<p>I create class <code>closure</code> to describe this kind of environment and varible <code>curClosure</code> to  mark down current environment. Every time when calling a function, we enter a more inner environment. We do the following things to make sure that environment changes creately.</p>
<div class="codehilite"><pre><span></span><span class="n">saved</span> <span class="o">=</span> <span class="n">curClosure</span>
<span class="n">curClosure</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">closure</span>
<span class="n">call</span> <span class="n">function</span>
<span class="n">curClosure</span> <span class="o">=</span> <span class="n">saved</span>
</pre></div>


<h2 id="builtin-function-print">builtin function--print</h2>
<p>This function is just like function <code>printf</code> in clang.
Call it in the following format:
<code>print(FORMAT[,arg1,arg2...])</code>
The format string supports two kinds of format currently:
<em> <code>%d</code>: integer
</em> <code>%f</code>: float</p>
<p>If you want to print raw <code>%d</code>, not formatting. You can add a back slash <code></code> in front of <code>%</code>. (So it's with <code>%f</code>...)</p>
<p>For example:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;a=</span><span class="si">%d</span><span class="s1">, % \</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span> <span class="o">%</span><span class="n">d</span>
</pre></div>


<p>To implement this builtin function, we should firstly parse the formatting str. I parse the format-str and generate segs seperated by %d or %f.
For instance, <code>'fib[%d]=%d'</code> generates segs <code>['fib[','%d',']=','%d']</code>. 
For every seg, if it's string, generate instruction <code>('LIT',0,c)</code>, c is one chracter that consist of seg.
If it's <code>%d</code> or <code>%f</code>, we should first match comma, and then parse the followwing value and generate instructions. When in runtime, after executing there instructions, we will get a value(only take place one data-stack unit).</p>
<p>After handling all segs, we generate an instruction <code>('INT',2,n)</code>, which represents printing the top n units of data stack, and stk.top = stk.top-n.
N can be calculated by suming all lengths of str-seg, and num of format-seg.</p>
<h1 id="to-do">To do</h1>
<ul>
<li>[ ] array</li>
<li>[ ] different value pass</li>
<li>[ ] function pass</li>
<li>[ ] type </li>
<li>[ ] struct</li>
</ul>
    </body>  
</html>
