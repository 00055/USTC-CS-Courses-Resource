<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css">



  <link rel="icon" type="image/png" sizes="32x32" href="/yinyang.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/yinyang.png?v=6.4.2">










<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.2',
    sidebar: {"position":"left","width":350,"display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:                 //计算机与信息类/编译原理和技术/homework&amp;lab-郑启龙/lab2-pl0                                                 Directories">
<meta property="og:type" content="website">
<meta property="og:title" content="mbinary&#39;s blog">
<meta property="og:url" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/index.html">
<meta property="og:site_name" content="mbinary&#39;s blog">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:                 //计算机与信息类/编译原理和技术/homework&amp;lab-郑启龙/lab2-pl0                                                 Directories">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/data_stack.jpg">
<meta property="og:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/elseif_ins_stack.jpg">
<meta property="og:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/while_ins_stack.jpg">
<meta property="og:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/argument_pass.jpg">
<meta property="og:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/return_value.jpg">
<meta property="og:updated_time" content="2018-12-15T10:07:50.961Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mbinary&#39;s blog">
<meta name="twitter:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:                 //计算机与信息类/编译原理和技术/homework&amp;lab-郑启龙/lab2-pl0                                                 Directories">
<meta name="twitter:image" content="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/src/data_stack.jpg">



  <link rel="alternate" href="/atom.xml" title="mbinary's blog" type="application/atom+xml" />




  <link rel="canonical" href="https://mbinary.coding.me/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title> | mbinary's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">mbinary's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类<span class="badge">15</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签云<span class="badge">47</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />时间轴<span class="badge">39</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-leetcode">
    <a href="/leetcode/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-line-chart"></i> <br />leetcode</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-ustc-cs menu-item-active">
    <a href="/ustc-cs/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />CS课程资源</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="我来帮你找( •̀ ω •́ )✧" spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    

  


          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

<h2 class="post-title" itemprop="name headline"></h2>

<div class="post-meta">
  
  


  
  
  <ul class="breadcrumb">
    
      
      
        
          <li><a href="/ustc-cs/">USTC-CS</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/">计算机与信息类</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/编译原理和技术/">编译原理和技术</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/">HOMEWORK&LAB-郑启龙</a></li>
          
            
          
        
      
    
      
      
        
          <li>LAB2-PL0</li>
        
      
    
      
      
    
  </ul>


</div>

</header>

      
      
      
      <div class="post-body han-init-context">
        
        
          <script src="/assets/js/APlayer.min.js"> </script>

<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    <link href="https://mbinary0.github.io/resource/github.markdown.css" rel="stylesheet"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>
  <body>
     	<!-- hexo-inject:begin --><!-- hexo-inject:end --><div><h2>
                <a href="../index.html">&nbsp;&nbsp;<i class="fa fa-level-up"></i>&nbsp;&nbsp;</a>:
                /<a href="../../../../index.html"><i class="fa fa-home"></i></a>/<a href="../../../index.html">计算机与信息类</a>/<a href="../../index.html">编译原理和技术</a>/<a href="../index.html">homework&lab-郑启龙</a>/<a href="index.html">lab2-pl0</a>
            </h2>
        </div>
        
        
        <h2>Directories</h2>
        <ul>
        <li><a href="declarationParser/index.html"><i class="fa fa-folder"></i>&nbsp;declarationParser</a></li>
<li><a href="pl0_c/index.html"><i class="fa fa-folder"></i>&nbsp;pl0_c</a></li>
<li><a href="实验二-第八组-设计与演示文档与源代码/index.html"><i class="fa fa-folder"></i>&nbsp;实验二-第八组-设计与演示文档与源代码</a></li>
<li><a href="src/index.html"><i class="fa fa-folder"></i>&nbsp;src</a></li>
<li><a href="test/index.html"><i class="fa fa-folder"></i>&nbsp;test</a></li>
        </ul>

        <h2>Files</h2>
        <ul>
        <li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/parser.py" target="_blank" rel="noopener"><i class="fa fa-file-code-o"></i>&nbsp;parser.py---(29.84K)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/README.md" target="_blank" rel="noopener"><i class="fa fa-pencil-square-o"></i>&nbsp;README.md---(13.52K)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/实验二-第八组-设计与演示文档与源代码.zip" target="_blank" rel="noopener"><i class="fa fa-file-zip-o"></i>&nbsp;实验二-第八组-设计与演示文档与源代码.zip---(14.34M)</a></li>
<li><a href="https://raw.githubusercontent.com/mbinary/USTC-CS-Courses-Resource/master/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/token_scanner.py" target="_blank" rel="noopener"><i class="fa fa-file-code-o"></i>&nbsp;token_scanner.py---(2.80K)</a></li>
        </ul>

        <div style="text-decration:underline;display:inline">
        <a href="https://github.com/mbinary/USTC-CS-Courses-Resource.git" target="_blank" rel="external"><i class="fa fa-github"></i>&nbsp; Github</a>
        <a href="mailto:&#122;huheqin1@gmail?subject=反馈与建议" style="float:right" target="_blank" rel="external"><i class="fa fa-envelope"></i>&nbsp; Feedback</a>
        </div>

        <h1 style="color:red;text-align:center;">Read Me</h1>

<h1 id="pl0-compiler">PL0-compiler</h1>
<blockquote>
<p>A compiler for c-like programming language <strong>based on</strong> PL0, which is a dynamic, strong typing language.</p>
</blockquote>
<p>See grammar <a href="#grammar">here</a>, <a href="https://en.wikipedia.org/wiki/PL/0" target="_blank" rel="noopener">wikipedia-PL0</a>, and download <a href="src/编译原理和技术实践2017.pdf">this pdf(zh)</a> for more details.</p>
<h1 id="quickstart">QuickStart</h1>
<div class="codehilite"><pre><span></span>usage: parser.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-i<span class="o">]</span> <span class="o">[</span>-s<span class="o">]</span> <span class="o">[</span>-t<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-f FILE<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -i, --instruction     output instructions
  -s, --stack           output data stack when executing each instruction
  -t, --token           output tokens when parsing
  -v, --varible         output varibles <span class="k">for</span> every static environment
  -f FILE, --file FILE  compile and run codes. Without this arg, enter
                        interactive REPL
</pre></div>


<p>Run <code>python parse.py</code> and enter a REPL state, you can type and run sentences and expressions interactively</p>
<h1 id="examples">Examples</h1>
<p>Note that when in REPL, every sentence or expresion or block ends with '.'. But in program codes, only the whole program ends with a dot.</p>
<h2 id="interactive-expression">interactive-expression</h2>
<p>Therer are some expressions and sentence in file expr.txt, now test it.
<code>python parser.py -f test/expr.txt</code></p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="c1">// expression</span>
<span class="mi">2</span>     <span class="n">var</span> <span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="p">;.</span>

<span class="o">&gt;&gt;</span>  <span class="nl">c</span><span class="p">:</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="mf">1.</span>
<span class="o">&gt;&gt;</span> <span class="n">begin</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">!=</span><span class="mi">1</span> <span class="p">;</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="o">=</span><span class="mi">5</span> <span class="n">end</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">;</span> <span class="n">True</span><span class="p">;</span> <span class="n">True</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="k">for</span><span class="p">(;</span><span class="n">b</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="nl">b</span><span class="p">:</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span><span class="p">,</span><span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="p">.</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">14</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">60</span>
<span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="mi">58</span>
<span class="o">&gt;&gt;</span> <span class="n">begin</span> <span class="o">++</span><span class="mi">1</span><span class="o">--</span><span class="mi">1</span><span class="p">;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">%</span><span class="mi">2</span><span class="p">;</span> <span class="mi">2</span><span class="o">&amp;</span><span class="mi">1</span> <span class="n">end</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">;</span> <span class="mi">8</span><span class="p">;</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">&gt;&gt;</span>   <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="o">/%</span><span class="mf">2.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">;</span>
<span class="o">&gt;&gt;</span>    <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mf">2.</span>
<span class="n">line</span> <span class="mi">1</span><span class="o">:</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">.</span>
                <span class="o">^</span>
<span class="p">[</span><span class="n">Error</span><span class="p">]</span><span class="o">:</span> <span class="n">Expected</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="n">got</span> <span class="s">&quot;.&quot;</span>
<span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="o">!!</span><span class="p">.</span>
<span class="nl">result</span><span class="p">:</span> <span class="mi">620448401733239439360000</span><span class="p">;</span>
<span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="k">if</span>   <span class="mi">0</span> <span class="n">then</span> <span class="mi">1</span>
<span class="mi">2</span>     <span class="n">elif</span> <span class="mi">1</span><span class="o">&gt;</span><span class="mi">2</span> <span class="n">then</span> <span class="mi">2</span>
<span class="mi">3</span>     <span class="n">elif</span> <span class="nb">false</span> <span class="n">then</span> <span class="mi">3</span>
<span class="mi">4</span>     <span class="k">else</span> <span class="mf">4.</span>

<span class="nl">result</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">;</span>
</pre></div>


<h2 id="fibonacci">fibonacci</h2>
<p>Run <code>python parser.py  -f test/fibonacci.txt</code></p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="nl">codes</span><span class="p">:</span>
<span class="mi">1</span>     <span class="n">func</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="mi">2</span>     <span class="n">begin</span>
<span class="mi">3</span>         <span class="k">if</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span> <span class="o">||</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span> <span class="n">then</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">4</span>         <span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="mi">5</span>     <span class="n">end</span> <span class="p">;</span>
<span class="mi">6</span>     <span class="n">var</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">7</span>     <span class="n">begin</span>
<span class="mi">8</span>         <span class="k">while</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">15</span> <span class="k">do</span>
<span class="mi">9</span>         <span class="n">begin</span>
<span class="mi">10</span>            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">fib</span><span class="p">[</span><span class="o">%</span><span class="n">d</span><span class="p">]</span><span class="o">=%</span><span class="n">d</span><span class="err">&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="mi">11</span>            <span class="nl">n</span> <span class="p">:</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">12</span>        <span class="n">end</span><span class="p">;</span>
<span class="mi">13</span>    <span class="n">end</span>
<span class="mi">14</span>    <span class="p">.</span>

<span class="n">fib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mi">8</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="mi">13</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="mi">21</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="mi">34</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="mi">55</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="mi">89</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="mi">144</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="mi">233</span>
<span class="n">fib</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="mi">377</span>
</pre></div>


<p>Try the following commands to explore more examples.</p>
<div class="codehilite"><pre><span></span>python parser.py -f test/factorial.txt
python parser.py -f test/closure.txt
python parser.py -f test/closure.txt -i
python parser.py -f test/closure.txt -t
python parser.py -f test/closure.txt -s
python parser.py -f test/closure.txt -istv
python parser.py  <span class="c1"># enter interactive repl</span>
</pre></div>


<h1 id="description">Description</h1>
<h2 id="ident-type">ident type</h2>
<ul>
<li>constant</li>
<li>varible</li>
<li>function</li>
</ul>
<h2 id="operator">operator</h2>
<h3 id="relation-opr">relation opr</h3>
<ul>
<li>\&lt;</li>
<li>></li>
<li>\&lt;=</li>
<li>>=</li>
<li>= equal </li>
<li>!=</li>
<li>odd  </li>
</ul>
<h3 id="bit-opr">bit opr</h3>
<ul>
<li>\&amp; bitand</li>
<li>| bitor</li>
<li>\~ bitnot</li>
<li>\&lt;\&lt; left shift</li>
<li>>> right shift</li>
</ul>
<h3 id="arithmetic-opr">arithmetic opr</h3>
<ul>
<li>+  add/plus</li>
<li>-  sub/minus</li>
<li>*  multiply</li>
<li>\/  divide</li>
<li>\/\% integer div</li>
<li>%  mod</li>
<li>\^  power</li>
<li>!  factorial</li>
</ul>
<h3 id="conditon-opr">conditon opr</h3>
<ul>
<li>?:  eg   a>b ? c:d</li>
</ul>
<h2 id="control-structure">control structure</h2>
<ul>
<li>if elif else</li>
<li>for</li>
<li>while</li>
<li>break</li>
<li>continue</li>
<li>return</li>
</ul>
<h2 id="builtin-function">builtin function</h2>
<ul>
<li>print(formatStr,arg1,...)</li>
<li>random(), random(n)</li>
</ul>
<h1 id="grammar">Grammar</h1>
<div class="codehilite"><pre><span></span><span class="n">program</span> <span class="k">=</span>  <span class="n">body</span> <span class="s">&quot;.&quot;</span>
<span class="n">body</span> <span class="k">=</span> <span class="o">{</span><span class="n">varDeclaration</span> <span class="s">&quot;;&quot;</span> <span class="o">|</span>  <span class="n">constDeclaration</span> <span class="s">&quot;;&quot;</span> <span class="o">|</span>  <span class="s">&quot;func&quot;</span> <span class="n">ident</span> <span class="s">&quot;(&quot;</span> <span class="n">arg_list</span>  <span class="s">&quot;)&quot;</span> <span class="n">body</span> <span class="s">&quot;;&quot;</span><span class="o">}</span>  <span class="n">sentence</span>

<span class="n">varDeclaration</span> <span class="k">=</span> <span class="s">&quot;var&quot;</span>  <span class="n">varIdent</span> <span class="o">{</span> <span class="s">&quot;,&quot;</span> <span class="n">varIdent</span><span class="o">}</span>
<span class="n">varIdent</span>  <span class="k">=</span> <span class="n">ident</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">=</span><span class="err">&quot;</span> <span class="kt">number</span><span class="o">]</span> <span class="o">|</span> <span class="n">ident</span>  <span class="o">{</span> <span class="s">&quot;[&quot;</span> <span class="n">number</span> <span class="s">&quot;]&quot;</span> <span class="o">}</span> 
<span class="n">constDeclaration</span> <span class="k">=</span> <span class="s">&quot;const&quot;</span> <span class="n">ident</span> <span class="s">&quot;=&quot;</span> <span class="n">number</span> <span class="o">{</span><span class="s">&quot;,&quot;</span> <span class="n">ident</span> <span class="s">&quot;=&quot;</span> <span class="n">number</span><span class="o">}</span>

<span class="n">sentence</span> <span class="k">=</span> <span class="o">[</span> <span class="kt">ident</span> <span class="err">&quot;</span><span class="kt">:=</span><span class="err">&quot;</span> <span class="o">{</span> <span class="kt">ident</span> <span class="err">&quot;</span><span class="kt">:=</span><span class="err">&quot;</span> <span class="o">}</span> <span class="kt">sentenceValue</span> 
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">begin</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="o">{</span> <span class="err">&quot;;&quot;</span> <span class="kt">sentence</span><span class="o">}</span>  <span class="err">&quot;</span><span class="kt">end</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">if</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">then</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="o">{</span><span class="err">&quot;</span><span class="kt">elif</span><span class="err">&quot;</span> <span class="kt">sentence</span><span class="o">}</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">else</span><span class="err">&quot;</span> <span class="kt">sentence</span><span class="o">]</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">while</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">do</span><span class="err">&quot;</span> <span class="kt">sentence</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">do</span><span class="err">&quot;</span> <span class="kt">sentence</span> <span class="err">&quot;</span><span class="kt">while</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> 
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">switch</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">{</span><span class="err">&quot;</span><span class="kt">case</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">{</span><span class="err">&quot;</span>,<span class="err">&quot;</span> <span class="kt">sentenceValue</span><span class="o">}</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="o">[</span><span class="kt">setenceValue</span><span class="o">]}</span>  <span class="o">(</span><span class="kt">*</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">default</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span><span class="o">]</span>   <span class="kt">to</span> <span class="kt">do</span> <span class="kt">*</span><span class="o">)</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">break</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">continue</span><span class="err">&quot;</span>
                <span class="kt">|</span>  <span class="o">[</span><span class="err">&quot;</span><span class="kt">return</span><span class="err">&quot;</span><span class="o">]</span> <span class="kt">sentenceValue</span>
                <span class="kt">|</span>  <span class="err">&quot;</span><span class="kt">print</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="o">(</span><span class="err">&quot;</span> <span class="kt">str</span>,<span class="kt">real_arg_list</span> <span class="err">&quot;</span><span class="o">)</span><span class="err">&quot;</span> <span class="o">]</span>

<span class="n">sentenceValue</span> <span class="k">=</span>   <span class="n">condition</span>

<span class="n">arg_list</span> <span class="k">=</span>  <span class="n">ident</span> <span class="o">{</span> <span class="s">&quot;,&quot;</span> <span class="n">ident</span><span class="o">}</span>

<span class="n">real_arg_list</span> <span class="k">=</span> <span class="n">sentenceValue</span> <span class="o">{</span><span class="s">&quot;,&quot;</span> <span class="n">sentenceValue</span> <span class="o">}</span>


<span class="n">condition</span> <span class="k">=</span> <span class="n">condition_or</span> <span class="o">[</span> <span class="err">&quot;</span><span class="kt">?</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span> <span class="kt">sentenceValue</span> <span class="o">]</span>
<span class="n">condition_or</span>  <span class="k">=</span> <span class="n">condition_and</span> <span class="o">{</span> <span class="s">&quot;||&quot;</span> <span class="n">condition_or</span> <span class="o">}</span>
<span class="n">condition_and</span> <span class="k">=</span> <span class="n">condition_not</span> <span class="o">{</span> <span class="n">condition_not</span> <span class="s">&quot;&amp;&amp;&quot;</span> <span class="n">condition_and</span><span class="o">}</span>
<span class="n">condition_not</span> <span class="k">=</span> <span class="o">{</span><span class="s">&quot;!&quot;</span><span class="o">}</span> <span class="n">condition_unit</span>
<span class="n">condiiton_unit</span> <span class="k">=</span> <span class="o">[</span><span class="err">&quot;</span><span class="kt">odd</span><span class="err">&quot;</span><span class="o">]</span> <span class="n">expression</span>
                        <span class="o">|</span> <span class="n">expression</span> <span class="o">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&gt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&lt;=&quot;</span> <span class="o">|</span> <span class="s">&quot;&gt;=&quot;</span> <span class="o">|</span> <span class="s">&quot;=&quot;</span> <span class="o">|</span> <span class="s">&quot;!=&quot;</span><span class="o">)</span> <span class="n">expression</span>

<span class="n">expression</span> <span class="k">=</span>  <span class="n">level1</span> <span class="o">{</span> <span class="o">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="o">|</span> <span class="s">&quot;&gt;&gt;&quot;</span> <span class="o">|</span> <span class="s">&quot;&amp;&quot;</span> <span class="o">|</span> <span class="s">&quot;|&quot;</span><span class="o">)</span> <span class="n">level1</span> <span class="o">}</span>
<span class="n">level1</span>  <span class="k">=</span> <span class="n">level2</span> <span class="o">{</span> <span class="o">(</span> <span class="s">&quot;+&quot;</span> <span class="o">|</span> <span class="s">&quot;-&quot;</span> <span class="o">)</span> <span class="n">level2</span> <span class="o">}</span>
<span class="n">level2</span> <span class="k">=</span> <span class="n">level3</span> <span class="o">{</span> <span class="s">&quot;*&quot;</span> <span class="o">|</span> <span class="s">&quot;/&quot;</span> <span class="o">|</span> <span class="s">&quot;/%&quot;</span> <span class="o">|</span> <span class="s">&quot;%&quot;</span> <span class="o">)</span> <span class="n">level3</span> <span class="o">}</span>
<span class="n">level3</span> <span class="k">=</span> <span class="n">level4</span> <span class="o">{</span><span class="s">&quot;^&quot;</span> <span class="n">level4</span><span class="o">}</span>
<span class="n">level4</span> <span class="k">=</span> <span class="n">item</span> <span class="o">{</span><span class="s">&quot;!&quot;</span><span class="o">}</span>          <span class="o">(*</span>  <span class="n">factorial</span> <span class="o">*)</span>
<span class="n">item</span> <span class="k">=</span>  <span class="n">number</span><span class="o">|</span><span class="s">&quot;true&quot;</span><span class="o">|</span><span class="s">&quot;false&quot;</span> <span class="o">|</span> <span class="n">ident</span> <span class="o">{</span> <span class="s">&quot;(&quot;</span> <span class="n">real_arg_list</span> <span class="s">&quot;)&quot;</span> <span class="o">}|</span> <span class="s">&quot;(&quot;</span> <span class="n">sentenceValue</span><span class="s">&quot; )&quot;</span> <span class="o">|</span> <span class="o">(</span><span class="s">&quot;+&quot;</span> <span class="o">|</span> <span class="s">&quot;-&quot;</span> <span class="o">|</span> <span class="s">&quot;~&quot;</span> <span class="o">)</span> <span class="n">item</span>
</pre></div>


<h2 id="syntax">syntax</h2>
<p>Writet down syntax, then convert left recursion to right recursion.
Namely we should change the following productions:
expr, level0, level, level3</p>
<p>We notice that</p>
<div class="codehilite"><pre><span></span><span class="n">A</span> <span class="o">-&gt;</span> <span class="nc">Aa</span><span class="o">|</span><span class="n">b</span>
</pre></div>


<p>equls to </p>
<div class="codehilite"><pre><span></span><span class="n">A</span> <span class="o">-&gt;</span> <span class="n">bR</span>
<span class="n">R</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="n">aR</span>
</pre></div>


<p>so here are the  right-recursion productions </p>
<div class="codehilite"><pre><span></span><span class="n">expr</span>   <span class="o">-&gt;</span> <span class="n">level1</span> <span class="n">interval1</span>
<span class="n">interval1</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">{&amp;|</span><span class="sc">&#39;|&#39;</span><span class="o">|&gt;&gt;|&lt;&lt;|}</span> <span class="n">interval1</span>

<span class="n">level1</span> <span class="o">-&gt;</span> <span class="n">level2</span> <span class="n">interval2</span>
<span class="n">interval2</span> <span class="o">-&gt;</span> <span class="n">nli</span> <span class="o">|</span> <span class="o">{+|-}</span> <span class="n">interval2</span>

<span class="n">level2</span> <span class="o">-&gt;</span> <span class="n">level3</span> <span class="n">interval3</span>
<span class="n">interval3</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">{*|/|//|%}</span> <span class="n">interval3</span>

<span class="n">level3</span> <span class="o">-&gt;</span> <span class="n">level4</span> <span class="o">|</span> <span class="n">level4</span> <span class="o">^</span> <span class="n">level3</span>

<span class="n">level4</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="n">interval4</span> 
<span class="n">interval4</span> <span class="o">-&gt;</span> <span class="n">nil</span> <span class="o">|!</span> <span class="n">interval4</span>

<span class="n">item</span>   <span class="o">-&gt;</span> <span class="nc">NUM</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="nc">PI</span><span class="o">|</span><span class="n">ln</span><span class="o">(</span><span class="n">expr</span><span class="o">)|(</span><span class="n">expr</span><span class="o">)|</span> <span class="o">+</span> <span class="n">item</span><span class="o">|</span> <span class="o">-</span> <span class="n">item</span><span class="o">|</span> <span class="o">~</span> <span class="n">item</span>
</pre></div>


<p>When implementing the parser, we can use a loop structure to implement the right recursion because it's tail-recursive.</p>
<p>For instance, we can simply find that the production for <code>level4</code> is </p>
<div class="codehilite"><pre><span></span><span class="n">level4</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="o">|</span> <span class="n">item</span> <span class="o">!</span> <span class="o">|</span> <span class="n">item</span><span class="o">!!</span> <span class="o">|</span><span class="n">item</span> <span class="o">!!!</span> <span class="o">|</span> <span class="o">...</span>
</pre></div>


<p>Though we can't write a production with infinite loops, we can write it in code like this: </p>
<div class="codehilite"><pre><span></span><span class="n">match_level4</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">lookAhead</span>  <span class="n">matches</span> <span class="n">item</span><span class="p">:</span>
        <span class="n">match</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>


<h1 id="instruction-generation">Instruction generation</h1>
<p>We designed several instructions that can be generated for the target machine. 
To simplify this problem, we will emulate this virtual machine and execute instructions in python.</p>
<h2 id="register">register</h2>
<p>This machine has three registers:
<em> <code>b</code> is the base register that contains the base pointer to locate a varible in the data stack
</em> <code>regs</code> are a series of registers. Currently the first one is used for returning value of latest function call, and the second one is used to store the <code>switch</code> value
* <code>pc</code> is the pc register that points to the instruction </p>
<h2 id="stack">stack</h2>
<p>There are two stack in this virtual machine. 
One contains the instructions, visited by register <code>pc</code>. It won't change when executing instructions, so we can assume it's readonly
The other is data stack. It dynamiclly changes when running the program.</p>
<p>For each level, the first is the base address of this level. The second place is the static chain to visit the upper level's varibles. The third place contains the return address of the upper level.
And the other places in one level contains local varibles and real time data for calculation.
<img alt="" src="src/data_stack.jpg"></p>
<p>Each time we call a function, the level increases 1. Also, the level decreases 1 when we return from a function.</p>
<h2 id="instruction">instruction</h2>
<p>Every instruction consists of three parts. The first is the name of the instruction. Generally, the second is the level diifference of a identifier(if it has). And the third part is the address.</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">levelDiff</th>
<th align="center">address</th>
<th align="center">explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">INT</td>
<td align="center">0</td>
<td align="center">n</td>
<td align="center">allocate n space for one level</td>
</tr>
<tr>
<td align="center">INT</td>
<td align="center">1</td>
<td align="center">n</td>
<td align="center">rewind stk.top backward n steps</td>
</tr>
<tr>
<td align="center">INT</td>
<td align="center">2</td>
<td align="center">n</td>
<td align="center">print the top n elements of stack</td>
</tr>
<tr>
<td align="center">LIT</td>
<td align="center">-</td>
<td align="center">constant value</td>
<td align="center">push a constant value to the top of the data stack</td>
</tr>
<tr>
<td align="center">LOD</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">load a varible value to the top of the data stack. The var can be found use levelDiff and addr</td>
</tr>
<tr>
<td align="center">STO</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">store the stack top value to a varible, top decreases.</td>
</tr>
<tr>
<td align="center">CAL</td>
<td align="center">levelDiff</td>
<td align="center">addr</td>
<td align="center">call a function</td>
</tr>
<tr>
<td align="center">JMP</td>
<td align="center">-</td>
<td align="center">addr</td>
<td align="center">jmp to addr, namely set addr to pc</td>
</tr>
<tr>
<td align="center">JPC</td>
<td align="center">-</td>
<td align="center">addr</td>
<td align="center">pop stack, if the value is not True, jmp addr</td>
</tr>
<tr>
<td align="center">MOV</td>
<td align="center">n1</td>
<td align="center">n2</td>
<td align="center">stk[top-n2] = stk[top-n1]</td>
</tr>
<tr>
<td align="center">RET</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">return to the upper level, use current level's first three value to change pc, data stack, base register.</td>
</tr>
<tr>
<td align="center">POP</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">pop the data stack, store the value in <code>reg</code> register</td>
</tr>
<tr>
<td align="center">PUSH</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">push <code>reg</code> to stack top</td>
</tr>
<tr>
<td align="center">OPR</td>
<td align="center">-</td>
<td align="center">operator type</td>
<td align="center">variout operation on value</td>
</tr>
</tbody>
</table>
<h1 id="design">Design</h1>
<p>We can generate instruction when analysing grammar. 
Some keypoints is the control structures' instruction traslation.</p>
<h2 id="if-elif-else">if elif else</h2>
<p><img alt="" src="src/elseif_ins_stack.jpg"></p>
<h2 id="whilebreak">while/break</h2>
<p><img alt="" src="src/while_ins_stack.jpg">
<code>continue</code>, <code>for</code>  can be translated in the same way.</p>
<h2 id="switch">switch</h2>
<p>eg </p>
<div class="codehilite"><pre><span></span><span class="k">switch</span> <span class="n">n</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">1</span> <span class="n">or</span> <span class="mi">2</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">+</span><span class="mi">5</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;6&#39;</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">func_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>


<h2 id="function-arguments-pass">function arguments pass</h2>
<p>When analysing the function's defination, we can store the formal arguments as function's local varibles.
As soon as we call this function, we should calculate the real arguments in the level upper the function, and then pass value to the function's formal varibles one by one.</p>
<p>I use an instruction <code>MOV</code> to achive this goal. <code>MOV  addr1, addr2</code> will store value stk[top-n2] in stk[top-n1].
Let's have a look at how to call a function and pass args value.</p>
<p>Before we call a function, its real args will be calculated in the level upper this function. Note function level is n+1, and we call this function in level n.
In level n, we calculated function's args, all values are stored in the data stack of level n. Now call function and enter it. Data stack reaches level n+1 and grows three spaces for <code>DL</code>,<code>SL</code>,<code>RA</code>. The following space are for function's local varibles. So we can mov level n's real args value to these places according to function's argument num and varible num.</p>
<p>For example, function has n1 args, n2 local varibles(excluding args), then </p>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="o">.</span><span class="p">,</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">mov</span> <span class="p">,</span> <span class="n">n2</span><span class="o">+</span><span class="n">n1</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">n2</span> <span class="o">+</span> <span class="n">i</span>
</pre></div>


<p>The moment we returned level n, we should rewind top for n1 spaces, <code>OPR,n1,'BACK'</code> can make it.</p>
<p><img alt="" src="src/argument_pass.jpg"></p>
<h2 id="function-return">function return</h2>
<p>Also, mark function level as n+1, and outer(upper) is level n.
To implement <code>return</code> sentence, we just need to do two things:
<em> calculate <code>return</code> sentence value <strong>in level n+1</strong>
</em> pass this value to level n
It seems that it's hard to pass level n+1 's value to level n. Once we returned to level n, level n+1 's data in  data stack will be cleared.</p>
<p>I use a extra register <code>reg</code> to achive this. Before we return, 
<em> calculate return value
</em> <code>OPR ,0,'POP'</code>  will pop the value and store it in reg
<em> return level n
</em> <code>OPR,0,'PUSH'</code> will push reg value to stack top</p>
<p>Now the return value has be passed from level n+1 to level n
<img alt="" src="src/return_value.jpg"></p>
<h2 id="instruction-backpatching">instruction backpatching</h2>
<p>Taking <code>while</code> block as an example, Note that we don't know the <code>JPC</code> instruction's target addr until we finish analysing the whole block.The Solution is that after we analyse while condition, we generate an instruction with no target address, just take a place. We note down this instruction's address. As soon as we finish analysing the whole  <code>while</code> block, the instruction pointer, namely <code>ip</code>, pointing to the target address of <code>JPC</code>. Then we backpatch the <code>JPC</code> instruction with the target address along to ip.</p>
<h2 id="symbol-table">symbol table</h2>
<p>When analysing and translating, we want to get the symbol which including level, address,(value for constant) according to its name. The following shows how to achive it elegantly</p>
<p>There are three types of symbols:
<em> constant
</em> varible
* function name
Every function has an environment that contains this level's symbols, and an outer environment(except main function). Every environment has the three symbols mentioned above.</p>
<p>Defaultly, we are in the main function in the beginning of this program.</p>
<p>In an enviroment, when we meet a symbol, we should seek it in current environment. If not found, go for the outer environment recursively until we found it.</p>
<p>It gurantees that every environment has no same names for different symbols but may have same names in different environment.</p>
<p>So there won't be conflits when different functions have same local varibles or arguments.</p>
<p>I create class <code>closure</code> to describe this kind of environment and varible <code>curClosure</code> to  mark down current environment. Every time when calling a function, we enter a more inner environment. We do the following things to make sure that environment changes creately.</p>
<div class="codehilite"><pre><span></span><span class="n">saved</span> <span class="o">=</span> <span class="n">curClosure</span>
<span class="n">curClosure</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">closure</span>
<span class="n">call</span> <span class="n">function</span>
<span class="n">curClosure</span> <span class="o">=</span> <span class="n">saved</span>
</pre></div>


<h2 id="builtin-function-print">builtin function--print</h2>
<p>This function is just like function <code>printf</code> in clang.
Call it in the following format:
<code>print(FORMAT[,arg1,arg2...])</code>
The format string supports two kinds of format currently:
<em> <code>%d</code>: integer
</em> <code>%f</code>: float</p>
<p>If you want to print raw <code>%d</code>, not formatting. You can add a back slash <code></code> in front of <code>%</code>. (So it's with <code>%f</code>...)</p>
<p>For example:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;a=</span><span class="si">%d</span><span class="s1">, % \</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span> <span class="o">%</span><span class="n">d</span>
</pre></div>


<p>To implement this builtin function, we should firstly parse the formatting str. I parse the format-str and generate segs seperated by %d or %f.
For instance, <code>'fib[%d]=%d'</code> generates segs <code>['fib[','%d',']=','%d']</code>. 
For every seg, if it's string, generate instruction <code>('LIT',0,c)</code>, c is one chracter that consist of seg.
If it's <code>%d</code> or <code>%f</code>, we should first match comma, and then parse the followwing value and generate instructions. When in runtime, after executing there instructions, we will get a value(only take place one data-stack unit).</p>
<p>After handling all segs, we generate an instruction <code>('INT',2,n)</code>, which represents printing the top n units of data stack, and stk.top = stk.top-n.
N can be calculated by suming all lengths of str-seg, and num of format-seg.</p>
<h1 id="to-do">To do</h1>
<ul>
<li>[ ] array</li>
<li>[ ] different value pass</li>
<li>[ ] function pass</li>
<li>[ ] type </li>
<li>[ ] struct</li>
</ul><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    <script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300,"vOffset":-30},"mobile":{"show":false,"scale":0.3,"display":{"position":"right","width":20,"height":40,"vOffset":-10}},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>  
</html>

        
      </div>
      
      
      
    </div>
    


  
  
  <ul class="breadcrumb">
    
      
      
        
          <li><a href="/ustc-cs/">USTC-CS</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/">计算机与信息类</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/编译原理和技术/">编译原理和技术</a></li>
          
            
          
        
      
    
      
      
        
          <li><a href="/ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/">HOMEWORK&LAB-郑启龙</a></li>
          
            
          
        
      
    
      
      
        
          <li>LAB2-PL0</li>
        
      
    
      
      
    
  </ul>


    
    
    
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDA5Ni82NjUx"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/yinyang.png"
                alt="mbinary" />
            
              <p class="site-author-name" itemprop="name">mbinary</p>
              <p class="site-description motion-element" itemprop="description">淡泊明志, 宁静致远</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">39</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">47</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/mbinary" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.linkedin.com/in/cs-heqin-zhu" target="_blank" title="LinkedIn" rel="external nofollow"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://leetcode-cn.com/mbinary/" target="_blank" title="Leetcode" rel="external nofollow"><i class="fa fa-fw fa-code"></i>Leetcode</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.jianshu.com/u/a3bef26d9911" target="_blank" title="Jianshu" rel="external nofollow"><i class="fa fa-fw fa-pencil"></i>Jianshu</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://wpa.qq.com/msgrd?v=3&uin=414313516&site=qq&menu=yes" target="_blank" title="QQ" rel="external nofollow"><i class="fa fa-fw fa-qq"></i>QQ</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:zhuheqin1@gmail.com" target="_blank" title="Email" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>Email</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mbinary.coding.me/photo/index.html" title="相册" target="_blank">相册</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mbinary.coding.me/share-books.html" title="书籍" target="_blank">书籍</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mbinary.coding.me/video.html" title="影视" target="_blank">影视</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mbinary.coding.me/share/blogs.html" title="博客" target="_blank">博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mbinary.coding.me/share/tools.html" title="工具" target="_blank">工具</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">
                    :
                //计算机与信息类/编译原理和技术/homework&amp;lab-郑启龙/lab2-pl0
            </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Directories</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Files</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number"></span> <span class="nav-text">Read Me</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pl0-compiler"><span class="nav-number"></span> <span class="nav-text">PL0-compiler</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#quickstart"><span class="nav-number"></span> <span class="nav-text">QuickStart</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#examples"><span class="nav-number"></span> <span class="nav-text">Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#interactive-expression"><span class="nav-number">1.</span> <span class="nav-text">interactive-expression</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fibonacci"><span class="nav-number">2.</span> <span class="nav-text">fibonacci</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#description"><span class="nav-number"></span> <span class="nav-text">Description</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ident-type"><span class="nav-number">1.</span> <span class="nav-text">ident type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#operator"><span class="nav-number">2.</span> <span class="nav-text">operator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#relation-opr"><span class="nav-number">2.1.</span> <span class="nav-text">relation opr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bit-opr"><span class="nav-number">2.2.</span> <span class="nav-text">bit opr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arithmetic-opr"><span class="nav-number">2.3.</span> <span class="nav-text">arithmetic opr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#conditon-opr"><span class="nav-number">2.4.</span> <span class="nav-text">conditon opr</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#control-structure"><span class="nav-number">3.</span> <span class="nav-text">control structure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#builtin-function"><span class="nav-number">4.</span> <span class="nav-text">builtin function</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#grammar"><span class="nav-number"></span> <span class="nav-text">Grammar</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#syntax"><span class="nav-number">1.</span> <span class="nav-text">syntax</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#instruction-generation"><span class="nav-number"></span> <span class="nav-text">Instruction generation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#register"><span class="nav-number">1.</span> <span class="nav-text">register</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stack"><span class="nav-number">2.</span> <span class="nav-text">stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#instruction"><span class="nav-number">3.</span> <span class="nav-text">instruction</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#design"><span class="nav-number"></span> <span class="nav-text">Design</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#if-elif-else"><span class="nav-number">1.</span> <span class="nav-text">if elif else</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whilebreak"><span class="nav-number">2.</span> <span class="nav-text">while/break</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#switch"><span class="nav-number">3.</span> <span class="nav-text">switch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#function-arguments-pass"><span class="nav-number">4.</span> <span class="nav-text">function arguments pass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#function-return"><span class="nav-number">5.</span> <span class="nav-text">function return</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#instruction-backpatching"><span class="nav-number">6.</span> <span class="nav-text">instruction backpatching</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#symbol-table"><span class="nav-number">7.</span> <span class="nav-text">symbol table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#builtin-function-print"><span class="nav-number">8.</span> <span class="nav-text">builtin function--print</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#to-do"><span class="nav-number"></span> <span class="nav-text">To do</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div>
  <span class="with-love">
    <a href="https://github.com/mbinary"><i class="fa fa-github"></i></a>
    <a href="mailto:zhuheqin1@gmail.com?subject=feedback"><i class="fa fa-envelope"></i></a>
    <a href="http://wpa.qq.com/msgrd?v=3&uin=414313516&site=qq&menu=yes"><i class="fa fa-qq"></i></a>
    <a href="https://mbinary.coding.me/atom.xml"><i class="fa fa-feed"></i>
        <span class="with-love" id="heart">(。・∀・)ノ<i class="fa fa-heart"></i></span></a>
</span></div>
<div> 
  <span>
      Host: 
      <a class="host" href="https://mbinary.github.io"><i class="fa fa-github-alt"></i>Github</a>
      <a class="host" href="https://mbinary.coding.me"><i class="fa fa-code"></i>Coding</a>
  </span>
</div>
<div class="copyright">
  <span>
      <a class="theme-link" rel="external nofolow" href="https://hexo.io/themes/index.html">Hexo </a> 
      Theme:
      <a href="https://github.com/theme-next/hexo-theme-next">Next</a>
  </span>
  &nbsp;
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="https://ajax.cat.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  
    <script type="text/javascript">
      window.livereOptions = {
        refer: 'ustc-cs/计算机与信息类/编译原理和技术/homework&lab-郑启龙/lab2-pl0/index.html'
      };
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  

  


  
  

  
  
  
    
  
  <script src="https://cdn.jsdelivr.net/npm/pangu@3.3.0/dist/browser/pangu.min.js"></script>
  <script type="text/javascript">pangu.spacingPage();</script>


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.4.2"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.4.2"></script>


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300,"vOffset":-30},"mobile":{"show":false,"scale":0.3,"display":{"position":"right","width":20,"height":40,"vOffset":-10}},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
